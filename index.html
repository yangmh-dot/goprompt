<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sora v2 Prompt Generator - Loop Video Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">

    <div class="max-w-4xl mx-auto bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
        <div class="p-6 border-b border-gray-700 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-400"><i class="fa-solid fa-video"></i> Sora v2 循環影片提示詞生成器</h1>
            <span class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">Powered by GPT-4o Vision</span>
        </div>

        <div class="p-6 bg-gray-700 border-b border-gray-600">
            <label class="block text-sm font-medium text-gray-300 mb-2">OpenAI API Key (不會儲存，僅用於當次請求)</label>
            <input type="password" id="apiKey" placeholder="sk-..." class="w-full p-2 rounded bg-gray-900 border border-gray-600 text-white focus:border-blue-500 outline-none transition">
            <p class="text-xs text-gray-400 mt-1">* 必須使用 API Key 才能分析圖片。若無 Key，將使用預設的「豹與尖刺陷阱」範本。</p>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-blue-500 transition relative" id="dropZone">
                    <input type="file" id="fileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <div id="uploadPrompt">
                        <i class="fa-solid fa-cloud-upload-alt text-4xl text-gray-500 mb-2"></i>
                        <p class="text-gray-400">點擊或拖曳圖片至此</p>
                    </div>
                    <img id="preview" class="max-h-64 mx-auto hidden rounded shadow-lg" />
                </div>
                
                <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition flex justify-center items-center gap-2">
                    <span>生成 Sora 提示詞</span>
                    <div class="loader" id="loadingSpinner"></div>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-sm font-bold text-green-400">Sora Prompt (English)</label>
                        <button onclick="copyToClipboard('outputEn')" class="text-xs text-gray-400 hover:text-white"><i class="fa-regular fa-copy"></i> Copy</button>
                    </div>
                    <textarea id="outputEn" readonly class="w-full h-40 p-3 bg-gray-900 rounded border border-gray-700 text-gray-300 text-sm focus:outline-none resize-none" placeholder="Generated English prompt will appear here..."></textarea>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-sm font-bold text-yellow-400">描述 (中文)</label>
                        <button onclick="copyToClipboard('outputZh')" class="text-xs text-gray-400 hover:text-white"><i class="fa-regular fa-copy"></i> Copy</button>
                    </div>
                    <textarea id="outputZh" readonly class="w-full h-32 p-3 bg-gray-900 rounded border border-gray-700 text-gray-300 text-sm focus:outline-none resize-none" placeholder="中文描述將顯示於此..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const generateBtn = document.getElementById('generateBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const outputEn = document.getElementById('outputEn');
        const outputZh = document.getElementById('outputZh');
        const spinner = document.getElementById('loadingSpinner');
        
        let base64Image = "";

        // File Upload Handling
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    base64Image = e.target.result;
                    preview.src = base64Image;
                    preview.classList.remove('hidden');
                    uploadPrompt.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        // Generate Function
        generateBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            
            // UI State: Loading
            generateBtn.disabled = true;
            spinner.style.display = 'block';
            outputEn.value = "Analyzing image...";
            outputZh.value = "正在分析圖片...";

            // Fallback if no API Key (Simulation Mode for Demo)
            if (!apiKey) {
                setTimeout(() => {
                    alert("未輸入 API Key。將展示針對你截圖中「豹子陷阱」的預設範本。若要分析新圖片，請輸入 OpenAI API Key。");
                    const mockEn = "A photorealistic, wide-angle shot of a leopard cautiously balancing on the rim of a circular pit trap densely filled with sharp, rusted metal spikes. The environment is a dry, sunny savanna. In the center of the pit, a piece of raw meat hangs from a rope. The leopard stretches its paw tentatively to grab the meat, maintaining intense focus. The video loops seamlessly, emphasizing the tension, the texture of the spikes, and the realistic physics of the animal's movement. Cinematic lighting, 4k resolution, highly detailed fur textures.";
                    const mockZh = "逼真的廣角鏡頭，展示一隻豹子小心翼翼地在佈滿尖銳生鏽金屬刺的圓形陷阱邊緣保持平衡。環境是陽光明媚的乾燥大草原。陷阱中央，一塊生肉懸掛在繩子上。豹子試探性地伸出爪子去抓肉，神情專注。視頻無縫循環，強調緊張感、尖刺的質感以及動物運動的逼真物理效果。電影級布光，4k解析度，高度細緻的毛髮紋理。";
                    
                    outputEn.value = mockEn;
                    outputZh.value = mockZh;
                    resetUI();
                }, 1500);
                return;
            }

            if (!base64Image) {
                alert("請先上傳圖片！");
                resetUI();
                return;
            }

            // Real API Call to OpenAI
            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "system",
                                content: "You are an expert prompt engineer for OpenAI Sora v2. Your task is to analyze an image and generate a highly descriptive, physical, and cinematic video generation prompt. Focus on: 1. Subject & Action 2. Environment & Lighting 3. Physics & Texture (especially for traps/spikes) 4. Camera movement (make it loop-friendly). Output JSON format: { 'english_prompt': '...', 'chinese_description': '...' }"
                            },
                            {
                                role: "user",
                                content: [
                                    { type: "text", text: "Analyze this image and create a Sora prompt for a looping video of an animal trap/challenge." },
                                    { type: "image_url", image_url: { url: base64Image } }
                                ]
                            }
                        ],
                        max_tokens: 500,
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const result = JSON.parse(data.choices[0].message.content);
                outputEn.value = result.english_prompt;
                outputZh.value = result.chinese_description;

            } catch (error) {
                console.error(error);
                outputEn.value = "Error: " + error.message;
                outputZh.value = "發生錯誤，請檢查 API Key 是否正確。";
            } finally {
                resetUI();
            }
        });

        function resetUI() {
            generateBtn.disabled = false;
            spinner.style.display = 'none';
        }

        function copyToClipboard(id) {
            const copyText = document.getElementById(id);
            copyText.select();
            document.execCommand("copy");
            // Optional: visual feedback
        }
    </script>
</body>
</html>
